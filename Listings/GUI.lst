C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE GUI
OBJECT MODULE PLACED IN .\Objects\GUI.obj
COMPILER INVOKED BY: D:\Keil\C51\c51v960a\C51\BIN\C51.EXE HARDWARE\GUI\GUI.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\MAIN;.\de
                    -lay;.\HARDWARE\AIP650;.\HARDWARE\GUI;.\HARDWARE\PWM;.\HARDWARE\EEPROM;.\HARDWARE\ADC) DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\GUI.lst) TABS(2) OBJECT(.\Objects\GUI.obj)

line level    source

   1          #include "STC8G.H"
   2          #include "GUI.h"
   3          #include "main.h"
   4          #include "delay.h"
   5          #include "AIP650.h"
   6          #include "EEPROM.h"
   7          
   8          //通过extern可以合法使用已经定义的外部变量
   9          extern u8 DISPLAY_CODE[19];
  10          extern u8 Freq_Parm; //频率
  11          
  12          //extern u8  VOI_M;
  13          //extern u8  VOI;                           //按键操作标志
  14          
  15          u8 menu = 0;    //菜单
  16          u8 menu_flag = 0; //菜单标志
  17          u16 Pass = 0;   //通过次数
  18          u16 Alarm = 0;    //报警次数
  19          
  20          u8 flash_flag = 0; //闪烁标志
  21          u8 flash_M = 0;    //闪烁计数
  22          //---灵敏度-----------------------------------------
  23          u8 LMD_1;
  24          
  25          //--------保存密码-------------
  26          u8 mima1 = 0;
  27          u8 mima2 = 0;
  28          u8 mima3 = 0;
  29          u8 mima4 = 0;
  30          //--------输入密码-------------
  31          u8 mima5 = 1;
  32          u8 mima6 = 2;
  33          u8 mima7 = 3;
  34          u8 mima8 = 4;
  35          
  36          u8 PA_flag;     //密码位数标志
  37          u8 freq_flag = 0; //频率/声音显示标志
  38          u8 voice = 0;   //声音开关标志
  39          
  40          /********************************
  41          功能描述：UI界面
  42          入口参数：无
  43          返 回 值：无
  44          *********************************/
  45          void meun_UI()
  46          {
  47   1        switch (menu)
  48   1        {
  49   2        case 0:              //测试界面
  50   2          AiP650_DisPlayFour_1(Alarm); //报警次数
  51   2          PA_flag = 0;
  52   2          Freq_disp();
  53   2          break;
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 2   

  54   2        case 1:
  55   2          password_UI();
  56   2          break;
  57   2        case 2:
  58   2          LMD_XZ();
  59   2          PA_flag = 0;
  60   2          break;
  61   2        case 3:
  62   2          password_UI();
  63   2          break;
  64   2        default:
  65   2          break;
  66   2        }
  67   1      }
  68          
  69          /********************************
  70          功能描述：密码界面
  71          入口参数：无
  72          返 回 值：无
  73          *********************************/
  74          void password_UI()
  75          {
  76   1      
  77   1        flash_M++;
  78   1        if (flash_M < 120)
  79   1        {
  80   2          flash_flag = 1;
  81   2        }
  82   1        if (flash_M > 120)
  83   1        {
  84   2          flash_flag = 0;
  85   2        }
  86   1        if (flash_M == 240)
  87   1        {
  88   2          flash_M = 0;
  89   2        }
  90   1      
  91   1        //-----------------------------------
  92   1        if (PA_flag != 0)
  93   1        {
  94   2          AiP650_Set_1(0x68, DISPLAY_CODE[mima5]);
  95   2        }
  96   1        if (PA_flag != 1)
  97   1        {
  98   2          AiP650_Set_1(0x6A, DISPLAY_CODE[mima6]);
  99   2        }
 100   1        if (PA_flag != 2)
 101   1        {
 102   2          AiP650_Set_1(0x6C, DISPLAY_CODE[mima7]);
 103   2        }
 104   1        if (PA_flag != 3)
 105   1        {
 106   2          AiP650_Set_1(0x6E, DISPLAY_CODE[mima8]);
 107   2        }
 108   1        //-----------------------------------
 109   1        switch (PA_flag)
 110   1        {
 111   2        case 0:
 112   2      
 113   2          switch (flash_flag)
 114   2          {
 115   3          case 0:
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 3   

 116   3            AiP650_Set_1(0x68, DISPLAY_CODE[mima5]);
 117   3            break;
 118   3          case 1:
 119   3            AiP650_Set_1(0x68, DISPLAY_CODE[mima5] | 0x80);
 120   3            break;
 121   3          default:
 122   3            break;
 123   3          }
 124   2          break;
 125   2        case 1:
 126   2      
 127   2          switch (flash_flag)
 128   2          {
 129   3          case 0:
 130   3            AiP650_Set_1(0x6A, DISPLAY_CODE[mima6]);
 131   3            break;
 132   3          case 1:
 133   3            //             AiP650_Set_1(0x6A,0x40);
 134   3            AiP650_Set_1(0x6A, DISPLAY_CODE[mima6] | 0x80);
 135   3            break;
 136   3          default:
 137   3            break;
 138   3          }
 139   2          break;
 140   2      
 141   2        case 2:
 142   2          switch (flash_flag)
 143   2          {
 144   3          case 0:
 145   3            AiP650_Set_1(0x6C, DISPLAY_CODE[mima7]);
 146   3            break;
 147   3          case 1:
 148   3            //             AiP650_Set_1(0x6C,0x40);
 149   3            AiP650_Set_1(0x6C, DISPLAY_CODE[mima7] | 0x80);
 150   3            break;
 151   3          default:
 152   3            break;
 153   3          }
 154   2          break;
 155   2        case 3:
 156   2          switch (flash_flag)
 157   2          {
 158   3          case 0:
 159   3            AiP650_Set_1(0x6E, DISPLAY_CODE[mima8]);
 160   3            break;
 161   3          case 1:
 162   3            //             AiP650_Set_1(0x6E,0x40);
 163   3            AiP650_Set_1(0x6E, DISPLAY_CODE[mima8] | 0x80);
 164   3            break;
 165   3          default:
 166   3            break;
 167   3          }
 168   2          break;
 169   2        }
 170   1      }
 171          
 172          /************************************************** 
 173            功能描述: 加按钮处理
 174            入口参数：
 175            说    明：                        
 176          **************************************************/
 177          void ADD_UI()
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 4   

 178          {
 179   1        switch (menu)
 180   1        {
 181   2          //---频率调节---------------------------------
 182   2        case 0:
 183   2          freq_flag = 1; //显示标志
 184   2          Freq_Parm++;
 185   2          if (Freq_Parm > 9)
 186   2            Freq_Parm = 1;
 187   2      
 188   2          break;
 189   2          //---密码调节---------------------------------
 190   2        case 1:
 191   2          switch (PA_flag)
 192   2          {
 193   3          case 0:
 194   3            mima5++;
 195   3            if (mima5 > 9)
 196   3              mima5 = 0;
 197   3            break;
 198   3          case 1:
 199   3            mima6++;
 200   3            if (mima6 > 9)
 201   3              mima6 = 0;
 202   3            break;
 203   3          case 2:
 204   3            mima7++;
 205   3            if (mima7 > 9)
 206   3              mima7 = 0;
 207   3            break;
 208   3          case 3:
 209   3            mima8++;
 210   3            if (mima8 > 9)
 211   3              mima8 = 0;
 212   3            break;
 213   3          }
 214   2          break;
 215   2          //---灵敏度调节---------------------------------
 216   2        case 2:
 217   2          LMD_1++;
 218   2          if (LMD_1 > 99)
 219   2            LMD_1 = 1;
 220   2          break;
 221   2          //---密码调节---------------------------------
 222   2        case 3:
 223   2          switch (PA_flag)
 224   2          {
 225   3          case 0:
 226   3            mima5++;
 227   3            if (mima5 > 9)
 228   3              mima5 = 0;
 229   3            break;
 230   3          case 1:
 231   3            mima6++;
 232   3            if (mima6 > 9)
 233   3              mima6 = 0;
 234   3            break;
 235   3          case 2:
 236   3            mima7++;
 237   3            if (mima7 > 9)
 238   3              mima7 = 0;
 239   3            break;
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 5   

 240   3          case 3:
 241   3            mima8++;
 242   3            if (mima8 > 9)
 243   3              mima8 = 0;
 244   3            break;
 245   3          }
 246   2          break;
 247   2      
 248   2        default:
 249   2          break;
 250   2        }
 251   1      }
 252          
 253          /************************************************** 
 254            功能描述: 减按钮处理
 255            入口参数：
 256            说    明：                        
 257          **************************************************/
 258          void RED_UI()
 259          {
 260   1        switch (menu)
 261   1        {
 262   2          //---声音开关---------------------------------
 263   2        case 0:
 264   2          voice++;
 265   2          if (voice > 1)
 266   2            voice = 0;
 267   2          break;
 268   2          //---密码调节---------------------------------
 269   2        case 1:
 270   2          switch (PA_flag)
 271   2          {
 272   3          case 0:
 273   3            mima5--;
 274   3            if (mima5 == 255)
 275   3              mima5 = 9;
 276   3            break;
 277   3          case 1:
 278   3            mima6--;
 279   3            if (mima6 == 255)
 280   3              mima6 = 9;
 281   3            break;
 282   3          case 2:
 283   3            mima7--;
 284   3            if (mima7 == 255)
 285   3              mima7 = 9;
 286   3            break;
 287   3          case 3:
 288   3            mima8--;
 289   3            if (mima8 == 255)
 290   3              mima8 = 9;
 291   3            break;
 292   3          }
 293   2          break;
 294   2          //---灵敏度调节---------------------------------
 295   2        case 2:
 296   2          LMD_1--;
 297   2          if (LMD_1 == 255)
 298   2            LMD_1 = 99;
 299   2          break;
 300   2          //---密码调节---------------------------------
 301   2        case 3:
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 6   

 302   2          switch (PA_flag)
 303   2          {
 304   3          case 0:
 305   3            mima5--;
 306   3            if (mima5 == 255)
 307   3              mima5 = 9;
 308   3            break;
 309   3          case 1:
 310   3            mima6--;
 311   3            if (mima6 == 255)
 312   3              mima6 = 9;
 313   3            break;
 314   3          case 2:
 315   3            mima7--;
 316   3            if (mima7 == 255)
 317   3              mima7 = 9;
 318   3            break;
 319   3          case 3:
 320   3            mima8--;
 321   3            if (mima8 == 255)
 322   3              mima8 = 9;
 323   3            break;
 324   3          }
 325   2          break;
 326   2        default:
 327   2          break;
 328   2        }
 329   1      }
 330          
 331          /************************************************** 
 332            功能描述: 确定按钮处理
 333            入口参数：
 334            说    明：                        
 335          **************************************************/
 336          void ENT_UI()
 337          {
 338   1      
 339   1        switch (menu)
 340   1        {
 341   2          //-----密码确认-------------------------------
 342   2        case 1:
 343   2          PASS_DB();
 344   2          break;
 345   2          //-----灵敏度确认-------------------------------
 346   2        case 2:
 347   2          menu = 3;
 348   2          menu_flag = 2;
 349   2          break;
 350   2          //-----修改密码确认-------------------------------
 351   2        case 3:
 352   2      
 353   2          menu = 0;
 354   2          menu_flag = 0;
 355   2          break;
 356   2      
 357   2        default:
 358   2          break;
 359   2        }
 360   1      }
 361          
 362          /************************************************** 
 363            功能描述: 密码对比
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 7   

 364            入口参数：
 365            说    明：                        
 366          **************************************************/
 367          void PASS_DB()
 368          {
 369   1      
 370   1        //-----超级密码判断---------------------------------------------------
 371   1        if (mima5 == 8 && mima6 == 8 && mima7 == 8 && mima8 == 8)
 372   1        {
 373   2      
 374   2          AiP650_Set_1(0x68, DISPLAY_CODE[13]);
 375   2          MM_AIP650();
 376   2          delay_ms(800);
 377   2          //        CD_flag=4;ID1=0;
 378   2          mima5 = 1;
 379   2          mima6 = 2;
 380   2          mima7 = 3;
 381   2          mima8 = 4; //密码显示数字重置
 382   2        }
 383   1        //-----密码判断正确---------------------------------------------------
 384   1        else if (mima5 == mima1 && mima6 == mima2 && mima7 == mima3 && mima8 == mima4)
 385   1        {
 386   2      
 387   2          AiP650_Set_1(0x68, DISPLAY_CODE[13]);
 388   2          MM_AIP650();
 389   2      
 390   2          delay_ms(800);
 391   2          menu = 2;
 392   2          menu_flag = 1; //进入灵敏度设置
 393   2        }
 394   1        //-----密码判断错误---------------------------------------------------
 395   1        else
 396   1        {
 397   2      
 398   2          AiP650_Set_1(0x68, DISPLAY_CODE[15]);
 399   2          MM_AIP650();
 400   2          delay_ms(800);
 401   2          menu = 1;
 402   2          menu_flag = 0;
 403   2          mima5 = 1;
 404   2          mima6 = 2;
 405   2          mima7 = 3;
 406   2          mima8 = 4; //密码显示数字重置
 407   2        }
 408   1      }
 409          
 410          /************************************************** 
 411            功能描述: 密码确认显示信息
 412            入口参数：
 413            说    明：                        
 414          **************************************************/
 415          void MM_AIP650()
 416          {
 417   1        AiP650_Set_1(0x6A, DISPLAY_CODE[0]);
 418   1        AiP650_Set_1(0x6C, DISPLAY_CODE[0]);
 419   1        AiP650_Set_1(0x6E, DISPLAY_CODE[0]);
 420   1      }
 421          
 422          /************************************************** 
 423            功能描述: 灵敏度显示
 424            入口参数：
 425            说    明：                        
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 8   

 426          **************************************************/
 427          void LMD_XZ()
 428          {
 429   1        AiP650_Set_1(0x68, DISPLAY_CODE[1]);
 430   1        AiP650_Set_1(0x6A, DISPLAY_CODE[10]);
 431   1        AiP650_Set_1(0x6C, DISPLAY_CODE[LMD_1 % 100 / 10]);
 432   1        AiP650_Set_1(0x6E, DISPLAY_CODE[LMD_1 % 10]);
 433   1      }
 434          
 435          /************************************************** 
 436            功能描述: 频率设置显示
 437            入口参数：
 438            说    明：                        
 439          **************************************************/
 440          void Freq_disp()
 441          {
 442   1        switch (freq_flag)
 443   1        {
 444   2        case 0:
 445   2          /*        
 446   2              if(voice==1)
 447   2              {         
 448   2                AiP650_Set(0x68,DISPLAY_CODE[Pass%10000/1000]);   
 449   2                AiP650_Set(0x6A,DISPLAY_CODE[Pass%1000/100]);
 450   2                AiP650_Set(0x6C,DISPLAY_CODE[Pass%100/10]); 
 451   2                AiP650_Set(0x6E,DISPLAY_CODE[Pass%10]|0x80); 
 452   2              }
 453   2              else 
 454   2              {AiP650_DisPlayFour(Pass);}                        //通过次数
 455   2      */
 456   2          break;
 457   2        case 1:
 458   2          AiP650_Set(0x68, DISPLAY_CODE[16]); //F
 459   2          AiP650_Set(0x6A, DISPLAY_CODE[10]);
 460   2          AiP650_Set(0x6C, DISPLAY_CODE[Freq_Parm % 100 / 10]);
 461   2          AiP650_Set(0x6E, DISPLAY_CODE[Freq_Parm % 10]);
 462   2          delay_ms(1000);
 463   2          break;
 464   2        default:
 465   2          break;
 466   2        }
 467   1      }
 468          
 469          //----按键扫描---使用按钮时开启------------------------------
 470          //按钮地址： A-0x47,B-0x4F,C-0x57,D-0x5F,E-0x67,F-0x6F,G-0x77
 471          //
 472          //---------------------------------------------
 473          
 474          u8 Scan_Key(void)
 475          {
 476   1        u8 i;
 477   1        u8 rekey;
 478   1        I2CStart();
 479   1        I2CWrByte(0x49); //读按键命令
 480   1        I2Cask();
 481   1        for (i = 0; i < 8; i++)
 482   1        {
 483   2          CLK_H;
 484   2          rekey = rekey << 1;
 485   2          if (DIO)
 486   2          {
 487   3            rekey++;
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 9   

 488   3          }
 489   2          Delay_us(10);
 490   2          CLK_L;
 491   2        }
 492   1        I2Cask();
 493   1        I2CStop();
 494   1        return (rekey);
 495   1      }
 496          
 497          /**
 498           * 按键处理---使用按钮时开启
 499           * */
 500          void KEY_CL()
 501          {
 502   1        u8 KEY;
 503   1        KEY = Scan_Key();
 504   1        switch (KEY)
 505   1        {
 506   2          //K1   菜单键 ----------------------------------------------------
 507   2        case 0x47:
 508   2          if (menu == 0 && menu_flag == 0)
 509   2          {
 510   3            menu = 1;
 511   3            PA_flag = 3;
 512   3          } //主界面进入密码界面
 513   2          if (menu == 1 || menu == 3)
 514   2          {
 515   3            PA_flag++;
 516   3            if (PA_flag > 3)
 517   3              PA_flag = 0;
 518   3          }
 519   2          delay_ms(300);
 520   2          break;
 521   2      
 522   2          //K2    设置+ -------------------------------------
 523   2        case 0x4F:
 524   2          ADD_UI();
 525   2          freq_flag = 1;
 526   2          delay_ms(300);
 527   2          break;
 528   2          //K3    设置-   ----------------------------------------
 529   2        case 0x57:
 530   2          RED_UI();
 531   2          delay_ms(300);
 532   2          LED3 = 0;
 533   2          break;
 534   2          //K4    确认  ----------------------------------------
 535   2        case 0x5F: //K2
 536   2          ENT_UI();
 537   2          delay_ms(300);
 538   2          break;
 539   2        default:
 540   2          freq_flag = 0;
 541   2          break;
 542   2        }
 543   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1135    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
C51 COMPILER V9.60.0.0   GUI                                                               03/23/2021 11:36:25 PAGE 10  

   PDATA SIZE       =   ----    ----
   DATA SIZE        =     20       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
